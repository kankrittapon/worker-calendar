<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô & ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{ color-scheme: dark }
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #2d5a7b 100%);
        min-height: 100vh;
      }
      .card {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(56, 189, 248, 0.2);
      }
      .btn-primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        box-shadow: 0 4px 14px 0 rgba(14, 165, 233, 0.39);
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
      }
      .tab-active {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      }
    </style>
  </head>
  <body class="text-cyan-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô & ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h1>
          <p class="text-cyan-300/70 text-sm mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
        <nav class="flex gap-2 card rounded-xl p-1 w-fit">
          <button id="tabCalendar" class="px-4 py-2 rounded-lg tab-active text-slate-900 font-semibold">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
          <button id="tabList" class="px-4 py-2 rounded-lg hover:bg-slate-700/50 transition">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
        </nav>
      </header>

      <section class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <form id="eventForm" class="grid grid-cols-1 gap-3 card p-4 rounded-xl order-2 md:order-1 shadow-xl">
          <h2 class="font-semibold text-cyan-400 text-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="grid gap-1">
              <span class="text-sm text-cyan-300/80">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
              <input class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="date" type="date" required />
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-cyan-300/80">‡πÄ‡∏ß‡∏•‡∏≤</span>
              <input class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="time" type="time" required />
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-cyan-300/80">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
              <select class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="type" required>
                <option value="‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢">‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                <option value="‡πÉ‡∏ô‡∏Å‡∏£‡∏°">‡πÉ‡∏ô‡∏Å‡∏£‡∏°</option>
                <option value="‡∏ö‡∏Å.‡πÉ‡∏´‡∏ç‡πà">‡∏ö‡∏Å.‡πÉ‡∏´‡∏ç‡πà</option>
                <option value="‡∏ô‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢">‡∏ô‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
              </select>
            </label>
            <label class="grid gap-1">
              <span class="text-sm text-cyan-300/80">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>
              <input class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" required />
            </label>
            <label class="grid gap-1 md:col-span-2">
              <span class="text-sm text-cyan-300/80">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢</span>
              <input class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="uniform" placeholder="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢" required />
            </label>
            <label class="grid gap-1 md:col-span-2">
              <span class="text-sm text-cyan-300/80">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
              <input class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition" name="details" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" required />
            </label>
            <label class="grid gap-1 md:col-span-2">
              <span class="text-sm text-cyan-300/80">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</span>
              <textarea class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 outline-none transition resize-none" name="notes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" rows="2"></textarea>
            </label>
          </div>
          <div class="flex gap-2">
            <button class="btn-primary text-slate-900 font-semibold px-4 py-2 rounded-lg transition">
              <span id="formBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</span>
            </button>
            <button type="button" id="resetBtn" class="px-4 py-2 rounded bg-slate-700/50 hover:bg-slate-600/50 transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </form>

        <div class="card p-4 rounded-xl order-1 md:order-2 shadow-xl">
          <h2 class="font-semibold mb-3 text-cyan-400">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h2>
          <div class="flex items-center gap-2">
            <button id="prevBtn" class="px-3 py-2 bg-slate-700/50 rounded hover:bg-slate-600/50 transition">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <input id="monthPicker" class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 outline-none transition" type="month"/>
            <button id="nextBtn" class="px-3 py-2 bg-slate-700/50 rounded hover:bg-slate-600/50 transition">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            <button id="todayBtn" class="px-3 py-2 bg-slate-700/50 rounded hover:bg-slate-600/50 transition ml-auto">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          </div>
          <p class="text-cyan-300/60 text-sm mt-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</p>
        </div>

        <div class="card p-4 rounded-xl order-3 shadow-xl">
          <h2 class="font-semibold mb-3 text-cyan-400">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
          <div class="flex items-center gap-2">
            <input id="monthList" class="px-3 py-2 rounded bg-slate-800/50 border border-cyan-500/30 focus:border-cyan-400 outline-none transition" type="month"/>
            <button id="loadBtn" class="px-3 py-2 bg-slate-700/50 rounded hover:bg-slate-600/50 transition">‡πÇ‡∏´‡∏•‡∏î</button>
            <span id="status" class="text-sm text-cyan-300/70"></span>
          </div>
        </div>
      </section>

      <section id="calendarView" class="mt-6">
        <div class="grid grid-cols-7 text-center text-sm text-cyan-300/80 mb-1 font-semibold">
          <div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div><div>‡∏≠‡∏≤</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
      </section>

      <section id="listView" class="mt-6 hidden">
        <div id="list" class="space-y-2"></div>
      </section>
    </div>

    <template id="cellTpl">
      <div class="border border-cyan-500/20 rounded-lg p-2 min-h-[120px] flex flex-col gap-1 card backdrop-blur-sm">
        <div class="flex items-center justify-between">
          <span class="text-xs text-cyan-300/70 day-label"></span>
          <span class="text-xs px-2 py-0.5 rounded-full date-badge bg-slate-700/50"></span>
        </div>
        <div class="grow space-y-1 events"></div>
        <button class="mt-1 text-xs text-cyan-400 hover:text-cyan-300 hover:underline add-btn transition">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
      </div>
    </template>

    <script>
      // --- API helper (no prompt, public endpoints allowed by worker) ---
      function api(path, opts){
        opts = opts || {};
        var headers = Object.assign({'content-type':'application/json'}, (opts.headers||{}));
        return fetch(path, Object.assign({}, opts, { credentials:'include', headers: headers }))
          .then(function(res){ return res.ok ? res.json() : []; });
      }

      const pad=(n)=>String(n).padStart(2,'0');
      const fmtMonth=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      const todayLocal=()=> new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

      function buildCalendarMatrix(year, month){
        const first=new Date(year,month,1);
        const start=new Date(first);
        const day=(first.getDay()+6)%7; // ‡∏à=0 ... ‡∏≠‡∏≤=6
        start.setDate(first.getDate()-day);
        const weeks=[]; let cur=new Date(start);
        for(let w=0; w<6; w++){ const row=[]; for(let i=0;i<7;i++){ row.push(new Date(cur)); cur.setDate(cur.getDate()+1);} weeks.push(row); }
        return weeks;
      }
      function groupByDate(items){
        const m=new Map();
        (Array.isArray(items)?items:[]).forEach(ev=>{
          if(!m.has(ev.date)) m.set(ev.date, []);
          m.get(ev.date).push(ev);
        });
        return m;
      }

      let currentMonth = todayLocal(); currentMonth.setDate(1);

      function setForm(ev){
        const f=document.getElementById('eventForm');
        if(ev){
          f.dataset.editId=ev.id;
          f.date.value=ev.date; f.time.value=ev.time; f.type.value=ev.type;
          f.location.value=ev.location; f.uniform.value=ev.uniform; f.details.value=ev.details; f.notes.value=ev.notes||'';
          document.getElementById('formBtnText').textContent='‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô';
        }else{
          f.reset(); delete f.dataset.editId;
          document.getElementById('formBtnText').textContent='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô';
        }
      }

      async function renderCalendar(){
        const ym = fmtMonth(currentMonth);
        const data = await api('/api/events?month='+ym);
        const byDate = groupByDate(data);
        document.getElementById('monthPicker').value = ym;

        const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
        const weeks=buildCalendarMatrix(currentMonth.getFullYear(), currentMonth.getMonth()); const monthNum=currentMonth.getMonth(); const today=todayLocal();

        weeks.forEach(week=>{
          week.forEach(d=>{
            const clone=document.getElementById('cellTpl').content.cloneNode(true);
            const cell=clone.querySelector('div'); const dayLabel=clone.querySelector('.day-label'); const badge=clone.querySelector('.date-badge'); const evBox=clone.querySelector('.events'); const addBtn=clone.querySelector('.add-btn');
            const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate()); const key=`${y}-${m}-${dd}`;
            dayLabel.textContent=['‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™','‡∏≠‡∏≤'][(d.getDay()+6)%7]; badge.textContent=d.getDate();
            if(d.getMonth()!==monthNum) cell.classList.add('opacity-50'); if(d.getTime()===today.getTime()) badge.classList.add('bg-emerald-500','text-black','font-semibold');

            (byDate.get(key)||[]).slice(0,3).forEach(ev=>{
              const item=document.createElement('div');
              item.className='text-xs rounded px-2 py-1 truncate';
              item.title=`${ev.time} ${ev.type} @${ev.location} ‚Ä¢ ${ev.uniform} ‚Ä¢ ${ev.details}`;
              const color={'‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢':'bg-emerald-700/60','‡πÉ‡∏ô‡∏Å‡∏£‡∏°':'bg-sky-700/60','‡∏ö‡∏Å.‡πÉ‡∏´‡∏ç‡πà':'bg-amber-700/60','‡∏ô‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢':'bg-rose-700/60'}[ev.type]||'bg-zinc-800';
              item.classList.add(color);
              item.textContent=`${ev.time} ${ev.type} @${ev.location}`;
              item.addEventListener('click', function(){ setForm(ev); document.getElementById('tabList').click(); });
              evBox.appendChild(item);
            });
            const more=(byDate.get(key)||[]).length-3; if(more>0){ const moreEl=document.createElement('div'); moreEl.className='text-[11px] text-zinc-400'; moreEl.textContent=`+${more} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; evBox.appendChild(moreEl); }

            addBtn.addEventListener('click', function(){
              const f=document.getElementById('eventForm');
              f.date.value=key; f.time.focus();
              document.getElementById('tabList').click();
            });

            grid.appendChild(clone);
          });
        });
      }

      async function renderList(){
        const month=document.getElementById('monthList').value || fmtMonth(currentMonth);
        document.getElementById('monthList').value = month;
        const s=document.getElementById('status'); s.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        const items = await api('/api/events?month='+month).catch(function(){ return []; });
        const list=document.getElementById('list'); list.innerHTML='';
        (Array.isArray(items)?items:[]).forEach(ev=>{
          const row=document.createElement('div'); 
          row.className='rounded border border-zinc-800 p-3 bg-zinc-900';
          
          const container = document.createElement('div');
          container.className = 'flex justify-between items-start';
          
          const infoDiv = document.createElement('div');
          infoDiv.className = 'flex-1';
          
          const header = document.createElement('div');
          header.className = 'font-semibold';
          header.textContent = `${ev.date} ${ev.time} ‚Äî ${ev.type}`;
          
          const locationUniform = document.createElement('div');
          locationUniform.className = 'text-zinc-300';
          locationUniform.textContent = `üìç ${ev.location} ‚Ä¢ üëî ${ev.uniform}`;
          
          const details = document.createElement('div');
          details.className = 'text-zinc-400 mt-1';
          details.textContent = ev.details || '';
          
          infoDiv.appendChild(header);
          infoDiv.appendChild(locationUniform);
          infoDiv.appendChild(details);
          
          if (ev.notes) {
            const notes = document.createElement('div');
            notes.className = 'text-zinc-500 mt-1 text-sm';
            notes.textContent = `üìù ${ev.notes}`;
            infoDiv.appendChild(notes);
          }
          
          const btnDiv = document.createElement('div');
          btnDiv.className = 'flex gap-2 ml-4';
          
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded';
          editBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
          editBtn.setAttribute('data-id', ev.id);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded';
          deleteBtn.textContent = '‡∏•‡∏ö';
          deleteBtn.setAttribute('data-id', ev.id);
          
          btnDiv.appendChild(editBtn);
          btnDiv.appendChild(deleteBtn);
          
          container.appendChild(infoDiv);
          container.appendChild(btnDiv);
          row.appendChild(container);
          
          editBtn.addEventListener('click',()=> setForm(ev));
          deleteBtn.addEventListener('click', function(){
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
              api('/api/events/'+ev.id, { method:'DELETE' }).then(function(){ renderCalendar(); renderList(); });
            }
          });
          list.appendChild(row);
        });
        s.textContent='';
      }

      document.getElementById('eventForm').addEventListener('submit', function(e){
        e.preventDefault(); const f=e.target; const fd=new FormData(f);
        const data = {}; fd.forEach((v,k)=> data[k]=v);
        var req;
        if(f.dataset.editId) req = api('/api/events/'+f.dataset.editId, { method:'PUT', body: JSON.stringify(data) });
        else req = api('/api/events', { method:'POST', body: JSON.stringify(data) });
        req.then(function(res){
          setForm(null);
          renderCalendar(); renderList();
        }).catch(function(){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); });
      });
      document.getElementById('resetBtn').addEventListener('click', function(){ setForm(null); });

      document.getElementById('prevBtn').addEventListener('click',function(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); });
      document.getElementById('nextBtn').addEventListener('click',function(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); });
      document.getElementById('todayBtn').addEventListener('click',function(){ const t=todayLocal(); currentMonth=new Date(t.getFullYear(),t.getMonth(),1); renderCalendar(); });
      document.getElementById('monthPicker').addEventListener('change',function(e){ const arr=e.target.value.split('-').map(Number); currentMonth=new Date(arr[0],arr[1]-1,1); renderCalendar(); });
      document.getElementById('loadBtn').addEventListener('click', function(){ renderList(); });

      // tab toggle
      const tabCal = document.getElementById('tabCalendar');
      const tabList = document.getElementById('tabList');
      const calendarView = document.getElementById('calendarView');
      const listView = document.getElementById('listView');
      function activate(tab){
        if(tab==='cal'){
          tabCal.classList.add('tab-active', 'text-slate-900', 'font-semibold');
          tabCal.classList.remove('hover:bg-slate-700/50');
          tabList.classList.remove('tab-active', 'text-slate-900', 'font-semibold');
          tabList.classList.add('hover:bg-slate-700/50');
          calendarView.classList.remove('hidden');
          listView.classList.add('hidden');
        }else{
          tabList.classList.add('tab-active', 'text-slate-900', 'font-semibold');
          tabList.classList.remove('hover:bg-slate-700/50');
          tabCal.classList.remove('tab-active', 'text-slate-900', 'font-semibold');
          tabCal.classList.add('hover:bg-slate-700/50');
          listView.classList.remove('hidden');
          calendarView.classList.add('hidden');
        }
      }
      tabCal.addEventListener('click', function(){ activate('cal'); });
      tabList.addEventListener('click', function(){ activate('list'); renderList(); });

      // init
      (function init(){
        document.getElementById('monthList').value = fmtMonth(currentMonth);
        renderCalendar(); renderList();
      })();
    </script>
  </body>
</html>
